<!DOCTYPE html>
<html>
  <head>
    <title>Parish AR World</title>

    <!-- Latest A-Frame -->
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>

    <!-- Updated AR.js build -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

    <!-- GPS place component -->
    <script src="https://unpkg.com/aframe-gps-entity-place/dist/aframe-gps-entity-place.min.js"></script>

    <style>
      #parishSelector {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 9999;
        font-size: 16px;
        padding: 5px;
        border-radius: 6px;
      }
      #gpsDebug {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(255,255,255,0.7);
        padding: 5px 8px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 9999;
      }
    </style>
  </head>
  <body style="margin:0; overflow:hidden;">

    <!-- Dropdown Menu -->
    <select id="parishSelector">
      <option value="parishes/kingston.json">Kingston</option>
      <option value="parishes/stmary.json">St. Mary</option>
      <option value="parishes/spanishtown.json">Spanish Town</option>
      <option value="parishes/test.json">Test Mode</option>
    </select>

    <!-- Debug info -->
    <div id="gpsDebug">Waiting for GPS...</div>

    <!-- AR Scene -->
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; gpsMinAccuracy: 100; debugUIEnabled: false;"
    >
      <!-- Assets -->
      <a-assets>
        <a-asset-item id="duck" src="./assets/Duck.glb"></a-asset-item>
      </a-assets>

      <!-- Camera -->
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      // Update GPS debug live
      window.addEventListener("gps-camera-update-position", e => {
        document.getElementById("gpsDebug").innerText =
          `Lat: ${e.detail.position.latitude.toFixed(5)}, Lng: ${e.detail.position.longitude.toFixed(5)}, Acc: ${e.detail.position.accuracy}m`;
      });

      async function loadParish(parishFile) {
        // Clear previous drops
        document.querySelectorAll("[gps-entity-place]").forEach(el => el.remove());

        // Fetch parish data
        const response = await fetch(parishFile);
        const data = await response.json();

        data.drops.forEach(drop => {
          let el;
          if (drop.type === "text") {
            el = document.createElement("a-text");
            el.setAttribute("gps-entity-place", `latitude: ${drop.lat}; longitude: ${drop.lng}`);
            el.setAttribute("value", drop.content);
            el.setAttribute("color", "red");
            el.setAttribute("scale", "50 50 50");
            el.setAttribute("look-at", "[gps-camera]");
          }

          if (drop.type === "3d_model") {
            el = document.createElement("a-entity");
            el.setAttribute("gps-entity-place", `latitude: ${drop.lat}; longitude: ${drop.lng}`);
            el.setAttribute("gltf-model", drop.asset);
            el.setAttribute("scale", "15 15 15");
          }

          if (el) document.querySelector("a-scene").appendChild(el);
        });
      }

      // Load default parish (Kingston)
      loadParish("parishes/kingston.json");

      // Dropdown listener
      document.getElementById("parishSelector").addEventListener("change", (e) => {
        loadParish(e.target.value);
      });
    </script>
  </body>
</html>
